<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Show Checklist Power-Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    // We'll set a max number of items to show (you can adjust this)
    const MAX_CHECKLIST_ITEMS = 2;
    
    // You can replace this with your own icon URL if preferred
    const CHECKLIST_ICON = 'https://cdn.glitch.com/1b42d7fe-bda8-4af8-a6c8-eff0cea9e08a%2Fchecklist.png?1494946700421';
    
    // Our main Power-Up object
    window.TrelloPowerUp.initialize({
      // This is where we define our capabilities
      'card-badges': function(t, options) {
        console.log("card-badges capability triggered");
        
        // First, we need to fetch any checklists on this card
        return t.card('id')
          .then(function(card) {
            console.log("Card ID:", card.id);
            
            // Check if we have auth token
            return t.get('member', 'private', 'authToken')
              .then(function(authToken) {
                if (!authToken) {
                  console.log("No auth token available");
                  // Return a badge prompting authentication
                  return [{
                    text: 'Auth needed for checklist',
                    icon: CHECKLIST_ICON,
                    color: 'blue'
                  }];
                }
                
                // Directly fetch checklists since we have a token
                return fetchChecklists(t, card.id)
                  .then(function(checklists) {
                    console.log("Processing checklists for badges");
                    // Cache the fetched checklists
                    return t.set('card', 'shared', 'checklists', checklists)
                      .then(function() {
                        return showChecklist(t, checklists);
                      });
                  });
              });
          })
          .catch(function(error) {
            console.error("Error in card-badges:", error);
            return [{
              text: 'Error loading checklist',
              icon: CHECKLIST_ICON,
              color: 'red'
            }];
          });
      },
      
      // Add a refresh button on the back of the card
      'card-buttons': function(t, options) {
        return [{
          icon: CHECKLIST_ICON,
          text: 'Refresh Checklist',
          callback: function(t) {
            return t.card('id')
              .then(function(card) {
                console.log("Refreshing checklists for card:", card.id);
                
                // First check if we have an auth token
                return t.get('member', 'private', 'authToken')
                  .then(function(authToken) {
                    if (!authToken) {
                      console.log("No auth token - opening auth popup");
                      // If no auth token, we need to authenticate
                      return t.popup({
                        title: 'Authorization Required',
                        url: './authorize.html',
                        height: 140
                      });
                    } else {
                      console.log("Token found, fetching fresh checklist data");
                      // We have an auth token, so just refresh the data
                      return fetchChecklists(t, card.id)
                        .then(function(fetchedChecklists) {
                          console.log("Fetched checklists:", fetchedChecklists.length);
                          // Update our cache
                          return t.set('card', 'shared', 'checklists', fetchedChecklists)
                            .then(function() {
                              // Trigger a refresh of the card front
                              console.log("Data updated, closing popup");
                              return t.closePopup();
                            });
                        });
                    }
                  });
              });
          }
        }];
      }
    });
    
    // Function to show checklist items as badges
    function showChecklist(t, checklists) {
      console.log("Showing checklists:", checklists);
      
      if (!checklists || checklists.length === 0) {
        console.log("No checklists available");
        return [{
          text: 'No checklists found',
          icon: CHECKLIST_ICON,
          color: 'light-gray'
        }];
      }
      
      // Collect all incomplete checklist items
      let incompleteItems = [];
      
      checklists.forEach(function(checklist) {
        console.log("Processing checklist:", checklist.name);
        if (checklist.checkItems && checklist.checkItems.length > 0) {
          checklist.checkItems.forEach(function(item) {
            if (item.state !== 'complete') {
              incompleteItems.push({
                name: item.name,
                id: item.id,
                checklistName: checklist.name
              });
            }
          });
        }
      });
      
      console.log("Incomplete items found:", incompleteItems.length);
      
      // If there are no incomplete items, return a completed badge
      if (incompleteItems.length === 0) {
        return [{
          text: 'All items complete',
          icon: CHECKLIST_ICON,
          color: 'green'
        }];
      }
      
      // Only show up to MAX_CHECKLIST_ITEMS items
      const itemsToShow = incompleteItems.slice(0, MAX_CHECKLIST_ITEMS);
      
      // Create a badge for each item
      const badges = itemsToShow.map(function(item) {
        return {
          text: item.name,
          icon: CHECKLIST_ICON,
          color: 'blue',
          title: `From: ${item.checklistName}`, // Tooltip on hover
        };
      });
      
      // Add a +N more badge if there are more items
      if (incompleteItems.length > MAX_CHECKLIST_ITEMS) {
        badges.push({
          text: `+${incompleteItems.length - MAX_CHECKLIST_ITEMS} more`,
          icon: CHECKLIST_ICON,
          color: 'light-gray'
        });
      }
      
      console.log("Returning badges:", badges.length);
      return badges;
    }
    
    // Function to fetch checklists from Trello API
    function fetchChecklists(t, cardId) {
      console.log("Fetching checklists for card:", cardId);
      
      // We need the API key and token to make requests to the Trello API
      return t.get('member', 'private', 'authToken')
        .then(function(authToken) {
          // If we don't have an auth token, we'll have to get one
          if (!authToken) {
            console.log("No auth token found");
            return [];
          }
          
          // Replace YOUR_API_KEY with your actual API key
          const apiKey = '85a50712fbe777501c54e707ad3bd540';
          
          console.log("Making API request with token:", authToken.slice(0, 5) + "...");
          
          // Now make the actual API request to get the checklists
          return fetch(`https://api.trello.com/1/cards/${cardId}/checklists?key=${apiKey}&token=${authToken}`)
            .then(function(response) {
              if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
              }
              return response.json();
            })
            .then(function(data) {
              console.log("Received checklists:", data.length);
              return data;
            })
            .catch(function(error) {
              console.error('Error fetching checklists:', error);
              return [];
            });
        });
    }
  </script>
</body>
</html>
